@model ClssLib.San_Pham



<!-- Modal Hiển Thị Ảnh -->
<div class="modal fade" id="productImageModal" tabindex="-1" aria-labelledby="productImageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ảnh Sản Phẩm</h5>
                <button type="button" class="btn-close clsbtn" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="file" id="uploadProductImage" class="form-control">
                <div class="row" id="imagePreviewContainer">
                    <!-- Ảnh sẽ hiển thị tại đây -->
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" id="selectImages" class="btn btn-success">Chọn Ảnh</button>
            </div>
            
        </div>
    </div>
</div>



<h2>Thêm Sản Phẩm</h2>
<form asp-action="Create">
    <div asp-validation-summary="ModelOnly" class="text-danger"></div>
    <input class="form-control" type="hidden" id="lstSPCT" required="" name="lstSPCT" />

    <input class="form-control" type="hidden" id="productImages" name="productImages" />


    <button type="button" class="btn btn-secondary ms-2 anh_form" data-bs-toggle="modal" data-bs-target="#productImageModal">
        Thêm Ảnh
    </button>

    <div class="form-group mb-3">
        <label for="ten_san_pham" class="control-label">Tên Sản Phẩm</label>
        <select id="ten_san_pham" name="ten_san_pham" class="form-control select2">
            <option value="">-- Nhập hoặc chọn tên sản phẩm --</option>
            @foreach (var item in ViewBag.TenGiay as List<string>)
            {
                <option value="@item">@item</option>
            }
        </select>
        <span id="ten_san_pham_warning" class="text-danger" style="display: none;">⚠️ Tên sản phẩm đã tồn tại!</span>
    </div>


    <div class="form-group mb-3">
    <label asp-for="Loai_GiayID" class="control-label"></label>
    <select id="Loai_GiayID" name="Loai_GiayID" class="form-control select2" data-api="/Admin/SanPham/AddLoaiGiay">
        <option value="">-- Nhập hoặc chọn Loại Giày --</option>
        @foreach (var item in (IEnumerable<SelectListItem>)ViewBag.Loai_GiayID)
        {
            <option value="@item.Value">@item.Text</option>
        }
    </select>
    </div>

    <div class="mb-3 row">
        <div class="form-group col-md-4">
            <label asp-for="Chat_LieuID" class="control-label"></label>
            <select id="Chat_LieuID" name="Chat_LieuID" class="form-control select2" data-api="/Admin/SanPham/AddChatLieu">
        <option value="">-- Nhập hoặc chọn Chất Liệu --</option>
        @foreach (var item in (IEnumerable<SelectListItem>)ViewBag.Chat_LieuID)
        {
            <option value="@item.Value">@item.Text</option>
                }
            </select>
        </div>
        <div class="form-group col-md-4">
            <label asp-for="Co_GiayID" class="control-label"></label>

            <select id="Co_GiayID" name="Co_GiayID" class="form-control select2" data-api="/Admin/SanPham/AddCoGiay">
        <option value="">-- Nhập hoặc chọn Cổ Giày --</option>
        @foreach (var item in (IEnumerable<SelectListItem>)ViewBag.Co_GiayID)
        {
            <option value="@item.Value">@item.Text</option>
        }
            </select>
        </div>
        <div class="form-group col-md-4">
            <label asp-for="Danh_MucID" class="control-label"></label>


            <select id="Danh_MucID" name="Danh_MucID" class="form-control select2" data-api="/Admin/SanPham/AddDanhMuc">
        <option value="">-- Nhập hoặc chọn Danh Mục --</option>
        @foreach (var item in (IEnumerable<SelectListItem>)ViewBag.Danh_MucID)
        {
            <option value="@item.Value">@item.Text</option>
        }
        </select>
        </div>
    </div>
    <div class="mb-3 row">

        <div class="form-group col-md-4">
            <label asp-for="De_GiayID" class="control-label"></label>

            <select id="De_GiayID" name="De_GiayID" class="form-control select2" data-api="/Admin/SanPham/AddDeGiay">
        <option value="">-- Nhập hoặc chọn Đế Giày --</option>
        @foreach (var item in (IEnumerable<SelectListItem>)ViewBag.De_GiayID)
        {
            <option value="@item.Value">@item.Text</option>
        }
            </select>
        </div>
        <div class="form-group col-md-4">
            <label asp-for="Mui_GiayID" class="control-label"></label>
            
            <select id="Mui_GiayID" name="Mui_GiayID" class="form-control select2" data-api="/Admin/SanPham/AddMuiGiay">
        <option value="">-- Nhập hoặc chọn Mũi Giày --</option>
        @foreach (var item in (IEnumerable<SelectListItem>)ViewBag.Mui_GiayID)
        {
            <option value="@item.Value">@item.Text</option>
        }
            </select>
        </div>
        <div class="form-group col-md-4">
            <label asp-for="Kieu_DangID" class="control-label"></label>

            <select id="Kieu_DangID" name="Kieu_DangID" class="form-control select2" data-api="/Admin/SanPham/AddKieuDang">
        <option value="">-- Nhập hoặc chọn Kiểu Dáng --</option>
        @foreach (var item in (IEnumerable<SelectListItem>)ViewBag.Kieu_DangID)
        {
            <option value="@item.Value">@item.Text</option>
        }
            </select>
        </div>

    </div>
    <div class="form-group mb-3">
        <label asp-for="mo_ta" class="control-label">Mô Tả Sản Phẩm</label>
        <textarea asp-for="mo_ta" class="form-control"></textarea>
        <span asp-validation-for="mo_ta" class="text-danger"></span>
    </div>
    <div class="form-group">
        <input type="submit" value="Create" id="saveProduct" class="btn btn-primary" />
    </div>

</form>

<!-- Thêm màu sắc -->
<h2>Thêm Sản Phẩm Chi Tiết</h2>
<form>
    <div class="mb-3">
        <label class="form-label">Màu Sắc:</label>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                data-bs-target="#colorModal">
            +
        </button>
    </div>
    <div id="selectedColors" class="mb-3"></div>

    <div class="mb-3">
        <label class="form-label">Kích Cỡ:</label>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                data-bs-target="#sizeModal">
            +
        </button>
    </div>

    <div id="productTables"></div>
</form>

<!-- Modal chọn màu -->
<div class="modal fade" id="colorModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Chọn Màu Sắc</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                @foreach (var item in (IEnumerable<SelectListItem>)ViewData["Mau_SacID"])
                {
                    <div class="form-check">
                        <input class="form-check-input color-checkbox" type="checkbox"
                               value="@item.Text">@item.Text
                    </div>
                }

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" id="addColor">Thêm</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal chọn kích cỡ -->
<div class="modal fade" id="sizeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Chọn Kích Cỡ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                @foreach (var item in (IEnumerable<SelectListItem>)ViewData["Kich_ThuocID"])
                {
                    <div class="form-check">
                        <input class="form-check-input size-checkbox" type="checkbox" value="@item.Text">
                        @item.Text
                    </div>
                }

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" id="addSize">Thêm</button>
            </div>
        </div>
    </div>
</div>




<div id="productTables"></div>
<script>
    $(document).ready(function () {
        let selectedSizes = [];
        let uploadedImages = []; // Mảng lưu đường dẫn ảnh


        $(document).on("click", ".anh_form", function () {

            console.log(`🔹 Chọn ảnh `);
            $("#selectImages").hide(); // Ẩn nút "Chọn Ảnh" khi mở modal
            $("#imagePreviewContainer").html("");
            uploadedImages.forEach(url => {
                $("#imagePreviewContainer").append(`
                        <div class="col-md-3 mt-2">
                            <img src="${url}" class="img-thumbnail" width="100">
                        </div>
                    `);
            });
        });
        $(document).on("click", ".anh_form", function () {

            console.log(`🔹 Chọn ảnh `);
            $("#selectImages").hide(); // Ẩn nút "Chọn Ảnh" khi mở modal
            $("#imagePreviewContainer").html("");
            uploadedImages.forEach(url => {
                $("#imagePreviewContainer").append(`
                        <div class="col-md-3 mt-2">
                            <img src="${url}" class="img-thumbnail" width="100">
                        </div>
                    `);
            });
        });



        // // Khi mở modal, hiển thị ảnh đã có
        // $("#productImageModal").on("show.bs.modal", function () {
        //     $("#imagePreviewContainer").html("");
        //     uploadedImages.forEach(url => {
        //         $("#imagePreviewContainer").append(`
        //             <div class="col-md-3 mt-2">
        //                 <img src="${url}" class="img-thumbnail" width="100">
        //             </div>
        //         `);
        //     });
        // });

        // Khi chọn ảnh, tải lên server ngay lập tức
        $("#uploadProductImage").change(function () {
            let fileInput = this;
            let formData = new FormData();
            let file = fileInput.files[0];

            if (!file) return;

            formData.append("file", file);

            $.ajax({
                url: "/Admin/SanPham/UploadImage",
                type: "POST",
                data: formData,
                processData: false,
                contentType: false,
                success: function (response) {
                    if (response.success) {
                        uploadedImages.push(response.filePath);
                        $("#imagePreviewContainer").append(`
                            <div class="col-md-3 mt-2">
                                <img src="${response.filePath}" class="img-thumbnail" width="100">
                            </div>
                        `);
                        $("#productImages").val(JSON.stringify(uploadedImages)); // Lưu vào input ẩn
                    } else {
                        alert("❌ Lỗi khi tải ảnh!");
                    }
                },
                error: function () {
                    alert("⚠️ Có lỗi xảy ra khi tải ảnh!");
                }
            });
        });
        // Khi bấm nút "Chọn ảnh"
        $(document).on("click", ".choose-image-btn", function () {

            let color = $(this).data("color"); // Lấy màu từ data attribute
            console.log(`🔹 Chọn ảnh cho màu: ${color}`);

            $("#selectImages").data("color", color); // Lưu màu vào nút "Select Images"

            let storedImages = JSON.parse($("#productImages").val() || "[]");

            console.log(uploadedImages);
            $("#selectImages").show();
            $("#imagePreviewContainer").empty();

            console.log(uploadedImages);
            // Hiển thị danh sách ảnh đã lưu
            uploadedImages.forEach(url => {
                $("#imagePreviewContainer").append(`
                                        <div class="col-md-3 mt-2 d-inline-block">
                            <input type="checkbox" class="image-checkbox" value="${url}">
                            <img src="${url}" class="img-thumbnail" width="100">
                    </div>
                        `);
            });


            // storedImages.forEach(img => {
            //     $("#uploadedImages").append(`
            //         <div class="m-2 d-inline-block text-center">
            //         <input type="checkbox" class="image-checkbox" value="${img}">
            //         <img src="${img}" class="img-thumbnail" width="100">
            //     </div>
            // `);
            // });

            $('#productImageModal').modal('show');
        });

        // Khi bấm nút "Select Images"
        $(document).on("click", "#selectImages", function () {
            let selectedImages = [];

            // Lấy danh sách ảnh đã chọn
            $(".image-checkbox:checked").each(function () {
                selectedImages.push($(this).val());
            });

            console.log("✅ Ảnh đã chọn:", selectedImages);

            if (selectedImages.length > 0) {
                let color = $("#selectImages").data("color"); // Lấy màu đã lưu từ nút chọn ảnhconsole.log(`🎨 Màu sản phẩm: ${color}`);
                console.log(`🎨 Màu sản phẩm: ${color}`);

                let firstImage = selectedImages[0]; // Ảnh đầu tiên làm ảnh đại diện

                // ✅ Kiểm tra nếu tồn tại ảnh đại diện thì cập nhật
                let imgElement = $(`#img-${color}`);
                if (imgElement.length > 0) {
                    imgElement.attr("src", firstImage);
                } else {
                    console.warn(`⚠️ Không tìm thấy ảnh đại diện: #img-${color}`);
                }

                // ✅ Kiểm tra nếu bảng sản phẩm tồn tại thì lưu ảnh vào từng hàng chi tiết
                let table = $(`#table-${color}`);
                if (table.length > 0) {
                    table.find("tbody tr").each(function () {
                        let lstImgInput = $(this).find(".lst_img");
                        if (lstImgInput.length > 0) {
                            lstImgInput.val(JSON.stringify(selectedImages));
                        } else {
                            console.warn("⚠️ Không tìm thấy input .lst_img trong hàng.");
                        }
                    });
                } else {
                    console.warn(`⚠️ Không tìm thấy bảng sản phẩm: #table-${color}`);
                }
            }

            // Đóng modal sau khi chọn ảnh
            $('#productImageModal').modal('hide');
        });



        let danhSachTenGiay = @Html.Raw(Json.Serialize(ViewBag.TenGiay));
        console.log("✅ Danh sách tên giày:", danhSachTenGiay);

        // Khởi tạo Select2
        $("#ten_san_pham").select2({
            placeholder: "Nhập hoặc chọn tên sản phẩm",
            allowClear: true,
            tags: true,
            tokenSeparators: [',', ' ']
        });

        function kiemTraTrungLap(tenSanPham) {
            return danhSachTenGiay.some(item => item.toLowerCase() === tenSanPham.trim().toLowerCase());
        }

        // Bắt sự kiện khi chọn hoặc nhập mới
        $("#ten_san_pham").on("select2:selecting", function (e) {
            let tenSanPham = e.params.args.data.text;
            let warningElement = $("#ten_san_pham_warning");

            if (kiemTraTrungLap(tenSanPham)) {
                warningElement.show();
                alert("⚠️ Tên sản phẩm đã tồn tại! Vui lòng chọn tên khác.");
                e.preventDefault(); // Ngăn không cho chọn giá trị trùng lặp
            } else {
                warningElement.hide();
            }
        });

        // Ngăn gửi form nếu tên sản phẩm bị trùng
        $("#saveProduct").click(function (e) {
            let tenSanPham = $("#ten_san_pham").val();

            if (kiemTraTrungLap(tenSanPham)) {
                alert("⚠️ Tên sản phẩm đã tồn tại! Vui lòng chọn tên khác.");
                e.preventDefault(); // Ngăn form gửi đi nếu trùng tên
            }
        });

        console.log("✅ Sự kiện kiểm tra tên sản phẩm đã được kích hoạt.");



        console.log("✅ jQuery Version:", $.fn.jquery);

        if (typeof $.fn.select2 === "undefined") {
            console.warn("⚠️ Select2 chưa được tải! Đang tải lại...");
            $.getScript("https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js", function () {
                console.log("✅ Select2 đã tải lại!");
                khoiTaoSelect2(); // Khởi tạo lại Select2
            });
        } else {
            khoiTaoSelect2();
        }
        console.log("🔍 jQuery version:", $.fn.jquery);
        console.log("🔍 Select2 exists:", typeof $.fn.select2 !== "undefined");

        function khoiTaoSelect2() {
            $(".select2").each(function () {
                let apiUrl = $(this).data("api"); // Lấy API từ data-attribute nếu có

                $(this).select2({
                    placeholder: "Nhập hoặc chọn một tùy chọn",
                    allowClear: true,
                    tags: true,
                    tokenSeparators: [',', ' '],
                    createTag: function (params) {
                        let term = $.trim(params.term);
                        if (term === '') return null;

                        let exists = false;
                        $(this).find('option').each(function () {
                            if ($(this).text().toLowerCase() === term.toLowerCase()) {
                                exists = true;
                                return false;
                            }
                        });

                        if (exists) {
                            return null;
                        }

                        return {
                            id: term,
                            text: `Nhấn Enter để thêm mới "${term}"`,
                            newTag: true
                        };
                    }
                }).on('select2:select', function (e) {
                    let data = e.params.data;
                    let selectElement = $(this);

                    if (data.newTag) {
                        let realValue = data.text.replace(/Nhấn Enter để thêm mới\s*"(.+)"$/, '$1');

                        $.ajax({
                            url: apiUrl,
                            type: "POST",
                            contentType: "application/json",
                            data: JSON.stringify(realValue),
                            success: function (response) {
                                if (response.success) {
                                    let newOption = new Option(response.text, response.id, true, true);
                                    selectElement.append(newOption).trigger('change');
                                } else {
                                    alert("❌ Không thể thêm giá trị mới.");
                                }
                            },
                            error: function () {
                                alert("⚠️ Lỗi khi gửi dữ liệu.");
                            }
                        });
                    }
                });
            });

            console.log("✅ Select2 đã khởi tạo thành công!");
        }

        // 🔹 Xử lý sự kiện kiểm tra tên sản phẩm
        function kiemTraTenSanPham() {
            let danhSachTenGiay = @Html.Raw(Json.Serialize(ViewBag.TenGiay));
            console.log("✅ Danh sách tên giày:", danhSachTenGiay);

            $("#ten_san_pham").select2({
                placeholder: "Nhập hoặc chọn tên sản phẩm",
                allowClear: true,
                tags: true,
                tokenSeparators: [',', ' ']
            });

            function kiemTraTrungLap(tenSanPham) {
                return danhSachTenGiay.some(item => item.toLowerCase() === tenSanPham.trim().toLowerCase());
            }

            // Kiểm tra khi chọn hoặc nhập mới
            $("#ten_san_pham").on("select2:selecting", function (e) {
                let tenSanPham = e.params.args.data.text;
                let warningElement = $("#ten_san_pham_warning");

                if (kiemTraTrungLap(tenSanPham)) {
                    warningElement.show();
                    alert("⚠️ Tên sản phẩm đã tồn tại! Vui lòng chọn tên khác.");
                    e.preventDefault(); // Ngăn không cho chọn giá trị trùng lặp
                } else {
                    warningElement.hide();
                }
            });

            // Ngăn gửi form nếu tên sản phẩm bị trùng
            $("#saveProduct").click(function (e) {
                let tenSanPham = $("#ten_san_pham").val();

                if (kiemTraTrungLap(tenSanPham)) {
                    alert("⚠️ Tên sản phẩm đã tồn tại! Vui lòng chọn tên khác.");
                    e.preventDefault();
                }
            });

            console.log("✅ Sự kiện kiểm tra tên sản phẩm đã được kích hoạt.");
        }

        // Gọi kiểm tra tên sản phẩm sau khi Select2 đã tải
        kiemTraTenSanPham();
        
        $('#addColor').click(function () {
            console.log("đã nhấn thêm");
            $('.color-checkbox:checked').each(function () {
                let color = $(this).val();
                if ($(`#color-${color}`).length === 0) {
                    $('#selectedColors').append(`<span id="color-${color}" class="badge bg-secondary me-2">${color}</span>`);
                    $('#productTables').append(`
                    <div class="mt-4" id="table-${color}">
                        <h4>Sản phẩm - ${color}</h4>
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Tên Sản Phẩm</th>
                                    <th>Kích Cỡ</th>
                                    <th>Số Lượng</th>
                                    <th>Giá</th>
                                    <th >Ảnh</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                            </table>
                            <!-- Khu vực chọn ảnh thay vì tải ảnh -->
                        <div class="mt-2">
                            <label class="form-label">Ảnh Sản Phẩm ${color}</label>
                            <button type="button" class="btn btn-primary choose-image-btn" data-color="${color}">
                                Chọn ảnh
                            </button>
                            <div class="mt-2">
                                <img src="/img/default.png" class="img-thumbnail product-img" width="100" id="img-${color}">
                            </div>
                        </div>
                    </div>
                `);
                }
            });
            $('#colorModal').modal('hide');
            setTimeout(() => {
                $('.modal-backdrop').fadeOut(300, function () {
                    $(this).remove();
                });
                $('body').removeClass('modal-open'); // Loại bỏ lớp giữ nền bị tối
                initPerfectScrollbar();
            }, 300); // Đợi 300ms để hiệu ứng fade chạy
        });

        $('#addSize').click(function () {
            let tenSanPham = $("#ten_san_pham").val(); // Lấy tên sản phẩm đang chọn

            $('.size-checkbox:checked').each(function () {
                let size = $(this).val();

                $("[id^='table-']").each(function () {
                    let color = $(this).attr("id").replace("table-", ""); // Lấy màu từ ID của bảng
                    let tenSPCT = `${tenSanPham} [${color} - ${size}]`; // Định dạng tên sản phẩm

                    $(this).find("tbody").append(`
                    <tr>
                        <td>${tenSPCT}</td>
                        <td>${size}</td>
                        <td><input type="number" class="form-control quantity" data-size="${size}"></td>
                        <td><input type="number" class="form-control price" data-size="${size}"></td>
                        <td ><input type="text" class="form-control lst_img" data-size="${size}"></td>
                    </tr>
                `);
                });
            });

            $('#sizeModal').modal('hide');
            setTimeout(() => {
                $('.modal-backdrop').fadeOut(300, function () {
                    $(this).remove();
                });
                $('body').removeClass('modal-open'); // Loại bỏ lớp giữ nền bị tối
                initPerfectScrollbar();
            }, 300); // Đợi 300ms để hiệu ứng fade chạy
        });



        function initPerfectScrollbar() {
            if (typeof PerfectScrollbar !== "undefined") {
                document.querySelectorAll('.scrollable').forEach(el => {
                    if (!el._ps) { // Chỉ khởi tạo nếu chưa có
                        el._ps = new PerfectScrollbar(el, {
                            wheelSpeed: 1,
                            wheelPropagation: true,
                            minScrollbarLength: 20
                        });
                    } else {
                        el._ps.update(); // Cập nhật nếu đã tồn tại
                    }
                });
            } else {
                console.warn("⚠️ Perfect Scrollbar chưa được tải!");
            }
        }

        $('#saveProduct').click(function () {
            let sanPhamCTList = [];

            $("[id^='table-']").each(function () {
                let color = $(this).attr('id').replace('table-', ''); // Lấy màu

                console.log(`🟢 Đang kiểm tra bảng: #table-${color}`);

                let table = $(this);
                let rows = table.find("tbody tr");

                if (rows.length === 0) {
                    console.warn(`⚠️ Không có hàng sản phẩm nào trong #table-${color}`);
                }


                $(this).find("tbody tr").each(function () {
                    let size = $(this).find("td:nth-child(2)").text(); // Lấy kích cỡ
                    let quantity = $(this).find(".quantity").val(); // Lấy số lượng
                    let price = $(this).find(".price").val(); // Lấy giá

                    let imgUrl = $(this).find(".lst_img").val(); // Lấy danh sách ảnh từ ô ẩn

                    if (!tenSPCT) {
                console.warn(`⚠️ ten_SPCT bị null hoặc rỗng trong bảng #table-${color}`);
            }
                    

                    if (quantity > 0) {
                        sanPhamCTList.push({
                            Mau_Sac: color,
                            Kich_Thuoc: size,
                            so_luong: parseInt(quantity),
                            gia: parseInt(price),
                            imgUrl: imgUrl, // Lưu link ảnh vào object
                            trang_thai: 1,
                            ngay_tao: new Date().toISOString()
                        });
                    }
                });
            });
            // Chuyển dữ liệu thành JSON và gán vào input ẩn
            $('#lstSPCT').val(JSON.stringify(sanPhamCTList));

            let tenSanPham = $("#ten_san_pham").val();
            if (kiemTraTrungLap(tenSanPham)) {
                alert("⚠️ Tên sản phẩm đã tồn tại! Vui lòng chọn tên khác.");
                e.preventDefault();
            }

            // Gửi form
            $('form').submit();
        });

    });

    
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>


@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
}