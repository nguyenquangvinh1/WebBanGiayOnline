@model ClssLib.San_Pham



<!-- Modal Hiển Thị Ảnh -->
<div class="modal fade" id="productImageModal" tabindex="-1" aria-labelledby="productImageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ảnh Sản Phẩm</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <input type="file" id="uploadProductImage" class="form-control">
                <div class="row" id="imagePreviewContainer">
                    <!-- Ảnh sẽ hiển thị tại đây -->
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" id="selectImages" class="btn btn-success">Chọn Ảnh</button>
            </div>

        </div>
    </div>
</div>

<div class="card card-primary">
    <div class="card-header">
        <h3 class="card-title">Thêm Sản Phẩm</h3>
    </div>
    <div class="card-body">

        <form asp-action="Create" method="post">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>

            <input class="form-control" type="hidden" id="lstSPCT" required="" name="lstSPCT" />

            <input class="form-control" type="hidden" id="productImages" name="productImages" />


            <button type="button" class="btn btn-secondary ms-2 anh_form" data-toggle="modal" data-target="#productImageModal">
                Thêm Ảnh
            </button>

            <div class="form-group">
                <label for="ten_san_pham" class="col-form-label">Tên Sản Phẩm</label>
                <select id="ten_san_pham" name="ten_san_pham" class="form-control select2">
                    <option value="">-- Nhập hoặc chọn tên sản phẩm --</option>
                    @foreach (var item in ViewBag.TenGiay as List<string>)
                    {
                        <option value="@item">@item</option>
                    }
                </select>
                <span id="ten_san_pham_warning" class="text-danger" style="display: none;">⚠️ Tên sản phẩm đã tồn tại!</span>
            </div>


            <div class="form-group">
                <label asp-for="Loai_Giay" class="control-label"></label>
                <select id="Loai_GiayID" name="Loai_GiayID" class="form-control select2" data-api="/Admin/SanPham/AddLoaiGiay">
                    <option value="">-- Nhập hoặc chọn Loại Giày --</option>
                    @foreach (var item in (IEnumerable<SelectListItem>)ViewBag.Loai_GiayID)
                    {
                        <option value="@item.Value">@item.Text</option>
                    }
                </select>
            </div>

            <div class="row">
                <div class="col-sm-4">
                    <div class="form-group">
                        <label asp-for="Chat_LieuID" class="control-label"></label>
                        <select id="Chat_LieuID" name="Chat_LieuID" class="form-control select2" data-api="/Admin/SanPham/AddChatLieu">
                            <option value="">-- Nhập hoặc chọn Chất Liệu --</option>
                            @foreach (var item in (IEnumerable<SelectListItem>)ViewBag.Chat_LieuID)
                            {
                                <option value="@item.Value">@item.Text</option>
                            }
                        </select>
                    </div>
                </div>
                <div class="col-sm-4">

                    <div class="form-group">
                        <label asp-for="Co_GiayID" class="control-label"></label>

                        <select id="Co_GiayID" name="Co_GiayID" class="form-control select2" data-api="/Admin/SanPham/AddCoGiay">
                            <option value="">-- Nhập hoặc chọn Cổ Giày --</option>
                            @foreach (var item in (IEnumerable<SelectListItem>)ViewBag.Co_GiayID)
                            {
                                <option value="@item.Value">@item.Text</option>
                            }
                        </select>
                    </div>
                </div>
                <div class="col-sm-4">

                    <div class="form-group">
                        <label asp-for="Danh_MucID" class="control-label"></label>


                        <select id="Danh_MucID" name="Danh_MucID" class="form-control select2" data-api="/Admin/SanPham/AddDanhMuc">
                            <option value="">-- Nhập hoặc chọn Danh Mục --</option>
                            @foreach (var item in (IEnumerable<SelectListItem>)ViewBag.Danh_MucID)
                            {
                                <option value="@item.Value">@item.Text</option>
                            }
                        </select>
                    </div>
                </div>

            </div>
            <div class="row">
                <div class="col-sm-4">
                    <div class="form-group">
                        <label asp-for="De_GiayID" class="control-label"></label>

                        <select id="De_GiayID" name="De_GiayID" class="form-control select2" data-api="/Admin/SanPham/AddDeGiay">
                            <option value="">-- Nhập hoặc chọn Đế Giày --</option>
                            @foreach (var item in (IEnumerable<SelectListItem>)ViewBag.De_GiayID)
                            {
                                <option value="@item.Value">@item.Text</option>
                            }
                        </select>
                    </div>
                </div>
                <div class="col-sm-4">

                    <div class="form-group">
                        <label asp-for="Mui_GiayID" class="control-label"></label>

                        <select id="Mui_GiayID" name="Mui_GiayID" class="form-control select2" data-api="/Admin/SanPham/AddMuiGiay">
                            <option value="">-- Nhập hoặc chọn Mũi Giày --</option>
                            @foreach (var item in (IEnumerable<SelectListItem>)ViewBag.Mui_GiayID)
                            {
                                <option value="@item.Value">@item.Text</option>
                            }
                        </select>
                    </div>
                </div>
                <div class="col-sm-4">

                    <div class="form-group">
                        <label asp-for="Kieu_DangID" class="control-label"></label>

                        <select id="Kieu_DangID" name="Kieu_DangID" class="form-control select2" data-api="/Admin/SanPham/AddKieuDang">
                            <option value="">-- Nhập hoặc chọn Kiểu Dáng --</option>
                            @foreach (var item in (IEnumerable<SelectListItem>)ViewBag.Kieu_DangID)
                            {
                                <option value="@item.Value">@item.Text</option>
                            }
                        </select>
                    </div>
                </div>

            </div>

            <div class="form-group">
                <label asp-for="mo_ta" class="control-label">Mô Tả Sản Phẩm</label>
                <textarea asp-for="mo_ta" class="form-control"></textarea>
                <span asp-validation-for="mo_ta" class="text-danger"></span>
            </div>
            <div class="form-group">
                <button type="submit" class="btn btn-primary" id="saveProduct">thêm</button>
                @* <input type="submit" value="Create" id="saveProduct" class="btn btn-primary" /> *@
            </div>
        </form>

    </div>
</div>


<div class="card card-primary">
    <div class="card-header">
        <h2 class="card-title">Thêm Sản Phẩm Chi Tiết</h2>
    </div>
    <div class="card-body">

        <form>
            <div class="form-group">
                <label class="form-label">Màu Sắc:</label>
                <button type="button" class="btn btn-primary" data-toggle="modal"
                        data-target="#colorModal">
                    +
                </button>
            </div>
            <div id="selectedColors" class="mb-3"></div>

            <div class="form-group">
                <label class="form-label">Kích Cỡ:</label>
                <button type="button" class="btn btn-primary" data-toggle="modal"
                        data-target="#sizeModal">
                    +
                </button>
            </div>
            <div id="selectedSize" class="mb-3"></div>

        </form>
    </div>
</div>

<!-- Thêm màu sắc -->
<!-- Modal chọn màu -->
<div class="modal fade" id="colorModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Chọn Màu Sắc</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body " id="colorModalBody">
                @foreach (var item in (IEnumerable<SelectListItem>)ViewData["Mau_SacID"])
                {
                    <div class="form-check d-flex align-items-center">
                        <!-- Checkbox chọn màu -->
                        <input class="form-check-input color-checkbox me-2" type="checkbox" value="@item.Text">
                        @item.Text
                    </div>
                }

                <!-- Nút thêm màu mới -->
                <button class="btn btn-primary mt-3" id="showColorPicker">Thêm Màu Mới</button>

                <!-- Chọn màu mới -->
                <div id="colorPickerContainer" class="mt-3" style="display: none;">
                    <label>Color picker:</label>
                    <div class="input-group ">
                        <input type="text" class="form-control" id="newColor">
                        <div class="input-group-append">
                            <span class="input-group-text"><i class="fas fa-square"></i></span>
                        </div>
                    </div>

                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" id="addColor">Thêm</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal chọn kích cỡ -->
<div class="modal fade" id="sizeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Chọn Kích Cỡ</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body " id="sizeModalBody">
                @foreach (var item in (IEnumerable<SelectListItem>)ViewData["Kich_ThuocID"])
                {
                    <div class="form-check">
                        <input class="form-check-input size-checkbox" type="checkbox" value="@item.Text">
                        @item.Text
                    </div>
                }

                <!-- Nút thêm kích cỡ mới -->
                <button class="btn btn-primary mt-3" id="showSizePicker">Thêm kích cỡ Mới</button>

                <!-- Chọn kích cỡ mới -->
                <div id="sizePickerContainer" class="mt-3" style="display: none;">
                    <label>Size picker:</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="newSize">

                    </div>

                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" id="addSize">Thêm</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="quickEditModal" tabindex="-1" aria-labelledby="quickEditModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Thêm Nhanh Số Lượng & Giá</h5>
                <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="quickEditForm">
                    <div class="mb-3">
                        <label for="modalQuantity" class="form-label">Số Lượng</label>
                        <input type="number" class="form-control" id="modalQuantity" min="0" value="0">
                    </div>
                    <div class="mb-3">
                        <label for="modalPrice" class="form-label">Giá</label>
                        <input type="number" class="form-control" id="modalPrice" min="0" value="0">
                    </div>
                    <button class="btn btn-success">Lưu</button>
                </form>
            </div>
        </div>
    </div>
</div>



<div class="row">
    <div class="col-12">
        <div id="productTables" class="card">
        </div>
    </div>

</div>

<script>
    $(document).ready(function () {
        console.log("Document is ready!");
        // Các function khác
        let selectedSizes = [];
        let uploadedImages = []; // Mảng lưu đường dẫn ảnh


        $(document).on("click", ".anh_form", function () {

            console.log(`🔹 Chọn ảnh `);
            $("#selectImages").hide(); // Ẩn nút "Chọn Ảnh" khi mở modal
            $("#imagePreviewContainer").html("");
            uploadedImages.forEach(url => {
                $("#imagePreviewContainer").append(`
                                            <div class="col-md-3 mt-2">
                                                <img src="${url}" class="img-thumbnail" width="100">
                                            </div>
                                        `);
            });
        });

        $('#showSizePicker').click(function () {
            $('#sizePickerContainer').show();
            $('#newSize').focus();
        });

        // Khi nhấn Enter để thêm kích cỡ mới
        $('#newSize').keypress(function (e) {
            if (e.which == 13) { // Nhấn Enter
                let newSize = $('#newSize').val().trim();
                if (newSize !== "") {
                    $.ajax({
                        url: '/Admin/SanPham/ThemKichCo',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(newSize),
                        success: function (response) {
                            // Thêm checkbox kích cỡ mới vào danh sách
                            $('#sizeModalBody').append(`
                                        <div class="form-check">
                                            <input class="form-check-input size-checkbox" type="checkbox" value="${response}" checked> ${response}
                                        </div>
                                    `);
                            $('#sizePickerContainer').hide(); // Ẩn ô nhập kích cỡ
                            $('#newSize').val(''); // Xóa nội dung nhập
                        },
                        error: function () {
                            alert("Có lỗi xảy ra khi thêm kích cỡ.");
                        }
                    });
                }
            }
        });


        $('#showColorPicker').click(function () {
            $('#colorPickerContainer').show();
            $('#newColor').focus();
        });

        // Thêm màu mới khi nhấn Enter

        // Khi người dùng nhấn phím Enter trong ô nhập màu
        $('#newColor').keypress(function (e) {
            if (e.which == 13) { // Nhấn Enter
                let newColor = $('#newColor').val().trim();
                if (newColor !== "") {
                    $.ajax({
                        url: '/Admin/SanPham/ThemMau',
                        type: 'POST',
                        contentType: 'application/json', // Chuyển về JSON
                        data: JSON.stringify(newColor), // Chuyển thành JSON
                        success: function (response) {
                            $('#colorModalBody').append(`<div class="form-check">
                                        <!-- Checkbox chọn màu -->
                                            <input class="form-check-input color-checkbox me-2" type="checkbox" value="${response}" checked>
                                        <!-- Nút hiển thị màu -->
                                        <button class="btn text-white d-flex align-items-center justify-content-center"
                                                    style="background-color: ${response};
                                       border: 1px solid #ccc;
                                       width: 50px; height: 50px;
                                       border-radius: 8px;">
                    ${response}
                                        </button>
                                    </div>`);
                            $('#colorPickerContainer').hide();
                            $('#newColor').val('');
                        },
                        error: function () {
                            alert("Có lỗi xảy ra khi thêm màu.");
                        }
                    });
                }
            }
        });




        // Khi chọn ảnh, tải lên server ngay lập tức
        $("#uploadProductImage").change(function () {
            let fileInput = this;
            let formData = new FormData();
            let file = fileInput.files[0];

            if (!file) return;

            formData.append("file", file);

            $.ajax({
                url: "/Admin/SanPham/UploadImage",
                type: "POST",
                data: formData,
                processData: false,
                contentType: false,
                success: function (response) {
                    if (response.success) {
                        uploadedImages.push(response.filePath);
                        $("#imagePreviewContainer").append(`
                                                <div class="col-md-3 mt-2">
                                                    <img src="${response.filePath}" class="img-thumbnail" width="100">
                                                </div>
                                            `);
                        $("#productImages").val(JSON.stringify(uploadedImages)); // Lưu vào input ẩn
                    } else {
                        alert("❌ Lỗi khi tải ảnh!");
                    }
                },
                error: function () {
                    alert("⚠️ Có lỗi xảy ra khi tải ảnh!");
                }
            });
        });
        // Khi bấm nút "Chọn ảnh"
        $(document).on("click", ".choose-image-btn", function () {

            let color = $(this).data("color"); // Lấy màu từ data attribute
            console.log(`🔹 Chọn ảnh cho màu: ${color}`);

            $("#selectImages").data("color", color); // Lưu màu vào nút "Select Images"

            let storedImages = JSON.parse($("#productImages").val() || "[]");

            console.log(uploadedImages);
            $("#selectImages").show();
            $("#imagePreviewContainer").empty();

            console.log(uploadedImages);
            // Hiển thị danh sách ảnh đã lưu
            uploadedImages.forEach(url => {
                $("#imagePreviewContainer").append(`
                                                            <div class="col-md-3 mt-2 d-inline-block">
                                                <input type="checkbox" class="image-checkbox" value="${url}">
                                                <img src="${url}" class="img-thumbnail" width="100">
                                        </div>
                                            `);
            });



            $('#productImageModal').modal('show');
        });
        // Khi bấm nút "Select Images"
        $(document).on("click", "#selectImages", function () {
            let selectedImages = [];
            let exceededLimit = false;

            // Lấy danh sách ảnh đã chọn, giới hạn tối đa 6 ảnh
            $(".image-checkbox:checked").each(function (index) {
                if (index < 6) {
                    selectedImages.push($(this).val());
                } else {
                    exceededLimit = true;
                    return false; // Dừng khi đã đủ 6 ảnh
                }
            });

            if (exceededLimit) {
                alert("⚠️ Ảnh quá giới hạn! Chỉ có thể chọn tối đa 6 ảnh, các ảnh sau ảnh thứ 6 đã bị loại bỏ.");
            }


            console.log("✅ Ảnh đã chọn:", selectedImages);

            if (selectedImages.length > 0) {
                let color = $("#selectImages").data("color"); // Lấy màu sản phẩm
                console.log(`🎨 Màu sản phẩm: ${color}`);

                // ✅ Kiểm tra bảng sản phẩm có tồn tại không
                let table = $(`#table-${color}`);
                if (table.length === 0) {
                    console.warn(`⚠️ Không tìm thấy bảng sản phẩm: #table-${color}, kiểm tra lại màu đã chọn!`);
                    return;
                }

                // ✅ Cập nhật danh sách ảnh vào bảng sản phẩm
                table.find("tbody tr").each(function () {
                    let lstImgInput = $(this).find(".lst_img");
                    if (lstImgInput.length > 0) {
                        lstImgInput.val(selectedImages.join(",")); // Cập nhật danh sách ảnh dưới dạng chuỗi
                    } else {
                        console.warn("⚠️ Không tìm thấy input .lst_img trong hàng.");
                    }
                });

                // ✅ Hiển thị danh sách ảnh trong `imgSelected`
                let imgContainer = $(`#${color} .imgSelected`);
                imgContainer.empty(); // Xóa ảnh cũ trước khi thêm mới

                selectedImages.forEach(url => {
                    imgContainer.append(`
                                <img src="${url}" class="img-thumbnail me-2" width="100">
                            `);
                });
            }

            // Đóng modal sau khi chọn ảnh
            $('#productImageModal').modal('hide');
        });

        console.log("✅ jQuery Version:", $.fn.jquery);

        if (typeof $.fn.select2 === "undefined") {
            console.warn("⚠️ Select2 chưa được tải! Đang tải lại...");
            $.getScript("https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js", function () {
                console.log("✅ Select2 đã tải lại!");
                khoiTaoSelect2(); // Khởi tạo lại Select2
            });
        } else {
            khoiTaoSelect2();
        }
        //tim
        console.log("🔍 jQuery version:", $.fn.jquery);
        console.log("🔍 Select2 exists:", typeof $.fn.select2 !== "undefined");


        // Hàm khởi tạo Select2
        // Hàm khởi tạo Select2
        function khoiTaoSelect2() {
            $(".select2").each(function () {
                let apiUrl = $(this).data("api"); // Lấy API từ data-attribute nếu có

                $(this).select2({
                    placeholder: "Nhập hoặc chọn một tùy chọn",
                    allowClear: true,
                    tags: true,
                    tokenSeparators: [','], // Giữ nguyên khoảng trắng trong giá trị nhập
                    createTag: function (params) {
                        let term = params.term.trim(); // Không xóa khoảng trắng giữa các từ
                        if (term === "" || /^\s+$/.test(term)) return null; // Ngăn nhập toàn dấu cách

                        let exists = false;
                        $(this).find("option").each(function () {
                            if ($(this).text().toLowerCase() === term.toLowerCase()) {
                                exists = true;
                                return false;
                            }
                        });

                        if (exists) {
                            return null;
                        }

                        return {
                            id: term,
                            text: `Nhấn Enter để thêm mới \"${term}\"`,
                            newTag: true
                        };
                    }
                }).on("select2:select", function (e) {
                    let data = e.params.data;
                    let selectElement = $(this);

                    if (data.newTag) {
                        let realValue = data.text.replace(/Nhấn Enter để thêm mới\s*\"(.+)\"$/, "$1");

                        $.ajax({
                            url: apiUrl,
                            type: "POST",
                            contentType: "application/json",
                            data: JSON.stringify(realValue), // Gửi JSON thay vì chuỗi thuần túy
                            success: function (response) {
                                if (response.success) {
                                    let newOption = new Option(response.text, response.id, true, true);
                                    selectElement.append(newOption).trigger("change");
                                } else {
                                    alert("❌ Không thể thêm giá trị mới.");
                                }
                            },
                            error: function () {
                                alert("⚠️ Lỗi khi gửi dữ liệu.");
                            }
                        });
                    }
                });
            });

            $("#ten_san_pham").on("keypress", function (e) {
                if (e.which === 32) {
                    return; // Bỏ qua sự kiện khi nhấn Space
                }

                if (e.which === 13) { // Chỉ bắt sự kiện khi nhấn Enter
                    let tenSanPham = $(this).val().trim(); // Loại bỏ khoảng trắng đầu và cuối
                    let warningElement = $("#ten_san_pham_warning");

                    if (tenSanPham === "") {
                        e.preventDefault(); // Ngăn không cho nhập chuỗi chỉ có khoảng trắng
                        return;
                    }

                    if (kiemTraTrungLap(tenSanPham)) {
                        warningElement.show();
                        alert("⚠️ Tên sản phẩm đã tồn tại! Vui lòng chọn tên khác.");
                        e.preventDefault();
                    } else {
                        warningElement.hide();
                    }
                }
            });
        }



        // 🔹 Xử lý sự kiện kiểm tra tên sản phẩm
        function kiemTraTenSanPham() {
            let danhSachTenGiay = @Html.Raw(Json.Serialize(ViewBag.TenGiay));
            console.log("✅ Danh sách tên giày:", danhSachTenGiay);

            $("#ten_san_pham").select2({
                placeholder: "Nhập hoặc chọn tên sản phẩm",
                allowClear: true,
                tags: true,
                tokenSeparators: [',']
            });

            function kiemTraTrungLap(tenSanPham) {
                return danhSachTenGiay.some(item => item.toLowerCase() === tenSanPham.trim().toLowerCase());
            }

            // Kiểm tra khi chọn sản phẩm từ danh sách
            $("#ten_san_pham").on("select2:selecting", function (e) {
                let tenSanPham = e.params.args.data.text.trim();
                let warningElement = $("#ten_san_pham_warning");

                if (kiemTraTrungLap(tenSanPham)) {
                    warningElement.show();
                    alert("⚠️ Tên sản phẩm đã tồn tại! Vui lòng chọn tên khác.");
                    e.preventDefault();
                } else {
                    warningElement.hide();
                }
            });

            console.log("✅ Sự kiện kiểm tra tên sản phẩm đã được kích hoạt.");
        }




        // Gọi kiểm tra tên sản phẩm sau khi Select2 đã tải
        kiemTraTenSanPham();
        $("#colorModal").on("show.bs.modal", function () {
            console.log("Modal đang mở");
        });

        $('#colorModal').on('hidden.bs.modal', function () {
            $('.color-checkbox').prop('checked', false); // Bỏ chọn tất cả checkbox
        });

        $('.color-checkbox:checked').each(function () {
            let color = $(this).val();
            if ($(`#color-${color}`).length === 0) { // Chỉ thêm nếu chưa có
                $('#selectedColors').append(`<span id="color-${color}" class="badge bg-secondary me-2">${color}</span>`);
            }
        });


        // Thêm màu
        $(document).off("click", "#addColor").on("click", "#addColor", function () {
            console.log("Đã nhấn thêm");

            const checkedColors = $('.color-checkbox:checked').map(function () {
                return $(this).val().replace("#", "");
            }).get();

            // Xóa những màu không còn được chọn
            $('#selectedColors > span').each(function () {
                let color = $(this).attr("id").replace("color-", "");
                if (!checkedColors.includes(color)) {
                    $(this).remove();
                    $(`#table-${color}`).parent().remove(); // .row chứa bảng và ảnh
                    $(`#${color}`).remove();
                }
            });

            // Thêm màu mới
            checkedColors.forEach(color => {
                if ($(`#color-${color}`).length === 0) {
                    $('#selectedColors').append(`<span id="color-${color}" class="badge bg-secondary me-2">${color}</span>`);
                }

                if ($("#productTables").find(`#table-${color}`).length === 0) {
                    $('#productTables').append(`
                        <div class="row">
                            <div class="card col-md-6" id="table-${color}">
                                <div class="card-header">
                                    <h3 class="card-title">Sản phẩm màu ${color}</h3>
                                    <div class="card-tools">
                                        <button type="button" class="btn btn-primary btn-sm open-modal" data-color="${color}" data-toggle="modal" data-target="#quickEditModal">
                                            Thêm Nhanh
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body table-responsive p-0">
                                    <table class="table table-hover text-nowrap">
                                        <thead>
                                            <tr>
                                                <th>Tên Sản Phẩm</th>
                                                <th>Kích Cỡ</th>
                                                <th>Số Lượng</th>
                                                <th>Giá</th>
                                                <th class="d-none">Ảnh</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="card col-md-6" id="${color}">
                                <div class="card-header">
                                    <h3 class="card-title">Ảnh Sản Phẩm ${color}</h3>
                                </div>
                                <div class="card-body">
                                    <div class="mt-2">
                                        <label class="form-label">Ảnh Sản Phẩm ${color}</label>
                                        <button type="button" class="btn btn-primary choose-image-btn" data-color="${color}">
                                            Chọn ảnh
                                        </button>
                                        <div class="mt-2 imgSelected"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `);
                }
            });

            $('#colorModal').modal('hide');
            setTimeout(() => {
                $('.modal-backdrop').fadeOut(300, function () {
                    $(this).remove();
                });
                $('body').removeClass('modal-open');
            }, 300);
        });

        // Thêm kích cỡ
        $(document).off("click", "#addSize").on("click", "#addSize", function () {
            let tenSanPham = $("#ten_san_pham").val();

            const checkedSizes = $('.size-checkbox:checked').map(function () {
                return $(this).val();
            }).get();

            // Xóa size không còn được chọn
            $('#selectedSize > span').each(function () {
                let size = $(this).attr("id").replace("size-", "");
                if (!checkedSizes.includes(size)) {
                    $(this).remove();
                    $("[id^='table-'] tbody tr").each(function () {
                        if ($(this).find("td:eq(1)").text() === size) {
                            $(this).remove();
                        }
                    });
                }
            });

            // Thêm size mới
            checkedSizes.forEach(size => {
                if ($(`#size-${size}`).length === 0) {
                    $('#selectedSize').append(`<span id="size-${size}" class="badge bg-secondary me-2">${size}</span>`);
                }

                $("[id^='table-']").each(function () {
                    let color = $(this).attr("id").replace("table-", "");
                    let tenSPCT = `${tenSanPham} [${color} - ${size}]`;

                    if ($(this).find(`tbody tr:has(td:contains('${size}'))`).length === 0) {
                        $(this).find("tbody").append(`
                            <tr>
                                <td>${tenSPCT}</td>
                                <td>${size}</td>
                                <td><input type="number" class="form-control quantity" data-size="${size}"></td>
                                <td><input type="number" class="form-control price" data-size="${size}"></td>
                                <td class="d-none"><input type="text" class="form-control lst_img" data-size="${size}"></td>
                            </tr>
                        `);
                    }
                });
            });

            $('#sizeModal').modal('hide');
            setTimeout(() => {
                $('.modal-backdrop').fadeOut(300, function () {
                    $(this).remove();
                });
                $('body').removeClass('modal-open');
            }, 300);
        });





        function initPerfectScrollbar() {
            if (typeof PerfectScrollbar !== "undefined") {
                document.querySelectorAll('.scrollable').forEach(el => {
                    if (!el._ps) { // Chỉ khởi tạo nếu chưa có
                        el._ps = new PerfectScrollbar(el, {
                            wheelSpeed: 1,
                            wheelPropagation: true,
                            minScrollbarLength: 20
                        });
                    } else {
                        el._ps.update(); // Cập nhật nếu đã tồn tại
                    }
                });
            } else {
                console.warn("⚠️ Perfect Scrollbar chưa được tải!");
            }
        }

        $('#saveProduct').click(function () {

            let sanPhamCTList = [];
            let hasError = false; // Biến kiểm tra lỗi

            console.log("🔹 Đã chạy save");

            $("[id^='table-']").each(function () {
                let color = $(this).attr('id').replace('table-', '');
                let table = $(this);
                let rows = table.find("tbody tr");

                if (rows.length === 0) {
                    console.warn(`⚠️ Không có hàng sản phẩm nào trong #table-${color}`);
                    return; // Dừng gửi form nếu có lỗi
                }

                rows.each(function () {
                    let size = $(this).find("td:nth-child(2)").text();
                    let quantity = parseInt($(this).find(".quantity").val()) || 0;
                    let price = parseInt($(this).find(".price").val()) || 0;
                    let imgUrl = $(this).find(".lst_img").val();

                    if (quantity <= 0 || price <= 0) {
                        hasError = true; // Đánh dấu có lỗi
                        console.error(`❌ Lỗi: Màu: ${color}, Size: ${size}, SL: ${quantity}, Giá: ${price}`);
                    } else {
                        sanPhamCTList.push({
                            Mau_Sac: color,
                            Kich_Thuoc: size,
                            so_luong: quantity,
                            gia: price,
                            imgUrl: imgUrl,
                            trang_thai: 1,
                            ngay_tao: new Date().toISOString()
                        });
                    }
                });
            });

            if (hasError) {
                alert("⚠️ Vui lòng nhập số lượng và giá hợp lệ (> 0) cho tất cả sản phẩm.");
                return; // Dừng gửi form nếu có lỗi
            }
            if (sanPhamCTList.length === 0) {
                alert("⚠️ Bạn chưa chọn màu sắc và kích thước hợp lệ! Vui lòng kiểm tra lại.");
                e.preventDefault(); // Ngăn không gửi form
                return;
            }

            // Chuyển dữ liệu thành JSON và gán vào input ẩn
            $('#lstSPCT').val(JSON.stringify(sanPhamCTList));



            let danhSachTenGiay = @Html.Raw(Json.Serialize(ViewBag.TenGiay));
            function kiemTraTrungLap(tenSanPham) {
                return danhSachTenGiay.some(item => item.toLowerCase() === tenSanPham.trim().toLowerCase());
            }

            let tenSanPham = $("#ten_san_pham").val();
            if (kiemTraTrungLap(tenSanPham)) {
                alert("⚠️ Tên sản phẩm đã tồn tại! Vui lòng chọn tên khác.");
                return;
            }

            console.log("✅ Không có lỗi, gửi form...");
            $('form').submit();
            debugger;
        });
        let currentTable = null;

        // Mở modal và xác định bảng cần cập nhật
        $(document).off("click", ".open-modal").on("click", ".open-modal", function () {
            let color = $(this).data("color");
            currentTable = $(`#table-${color}`);
            $("#modalQuantity").val(""); // Reset input
            $("#modalPrice").val("");
            $("#quickEditModal").modal("show");
        });

        // Khi nhấn "Lưu", cập nhật tất cả sản phẩm trong bảng tương ứng
        $(document).off("click", "#quickEditForm").on("click", "#quickEditForm", function (e) {

            if (!currentTable) {
                alert("⚠️ Không tìm thấy bảng sản phẩm!");
                return;
            }

            let quantity = $("#modalQuantity").val();
            let price = $("#modalPrice").val();

            if (quantity === "" || price === "" || quantity < 0 || price < 0) {
                alert("⚠️ Vui lòng nhập số lượng và giá hợp lệ!");
                return;
            }

            // Cập nhật tất cả hàng trong bảng
            currentTable.find(".quantity").val(quantity);
            currentTable.find(".price").val(price);

            $("#quickEditModal").modal("hide");
        });
    });
</script>


@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
}